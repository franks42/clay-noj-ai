{:deps {babashka/nrepl-client {:git/url "https://github.com/babashka/nrepl-client"
                               :git/sha "19fbef2525e47d80b9278c49a545de58f48ee7cf"}}
 :tasks
 {clay:start
  {:doc "Start Clay/Noj server with live-reload and nREPL"
   :task (shell "clj -M start-clay.clj > clay-server.log 2>&1 &")}

  clay:stop
  {:doc "Stop Clay/Noj server"
   :task (do
           (println "ğŸ›‘ Stopping Clay/Noj server...")
           (shell {:continue true} "pkill -f start-clay")
           (shell {:continue true} "bash -c 'lsof -ti:7890 2>/dev/null | xargs kill -9 2>/dev/null'")
           (shell {:continue true} "bash -c 'lsof -ti:1971 2>/dev/null | xargs kill -9 2>/dev/null'")
           (Thread/sleep 1000)
           (println "âœ… Clay server stopped!"))}

  clay:restart
  {:doc "Restart Clay/Noj server"
   :task (do
           (run 'clay:stop)
           (Thread/sleep 2000)
           (run 'clay:start)
           (Thread/sleep 3000)
           (println "âœ… Clay server restarted!")
           (println "ğŸ“Š Notebook viewer: http://localhost:1971")
           (println "ğŸ”Œ nREPL server:    localhost:7890"))}

  clay:status
  {:doc "Check Clay/Noj server status"
   :task (do
           (println "ğŸ” Checking server status...")
           (println "\nğŸ“¡ nREPL (port 7890):")
           (let [result (shell {:continue true :out :string :err :string} "lsof -i:7890")]
             (if (and (zero? (:exit result)) (not-empty (:out result)))
               (println "  âœ… Port listening")
               (println "  âŒ Not running")))
           (println "\nğŸŒ HTTP Server (port 1971):")
           (let [port-result (shell {:continue true :out :string :err :string} "lsof -i:1971")
                 port-open? (and (zero? (:exit port-result)) (not-empty (:out port-result)))]
             (if port-open?
               (do
                 (println "  âœ… Port listening")
                 (print "  ğŸ”— Web server: ")
                 (let [http-result (shell {:continue true :out :string :err :string}
                                          "curl -s -o /dev/null -w '%{http_code}' http://localhost:1971/ --max-time 2")]
                   (if (and (zero? (:exit http-result))
                            (= "200" (clojure.string/trim (:out http-result))))
                     (println "âœ… Responding (HTTP 200)")
                     (println "âŒ Not responding"))))
               (println "  âŒ Not running")))
           (println))}

  clay:logs
  {:doc "View Clay/Noj server logs"
   :task (shell "tail -f clay-server.log")}

  clay:logs-last
  {:doc "View last 50 lines of Clay/Noj server logs"
   :task (shell "tail -50 clay-server.log")}

  test:e2e
  {:doc "Run Playwright E2E tests"
   :task (shell "npx playwright test test-stateful-params.spec.js")}

  test:e2e-headed
  {:doc "Run Playwright E2E tests with browser visible"
   :task (shell "npx playwright test test-stateful-params.spec.js --headed")}

  ;; Claude service tasks (using babashka.nrepl-client to connect to port 7888)
  claude:eval
  {:doc "Evaluate code in local-nrepl-server: bb claude:eval '(+ 1 2)'"
   :requires ([babashka.nrepl-client :as nrepl])
   :task (let [code (first *command-line-args*)]
           (if code
             (let [result (nrepl/eval-expr {:port 7888 :expr code})]
               (println (first (:vals result))))
             (println "Usage: bb claude:eval '(+ 1 2)'")))}

  claude:spawn
  {:doc "Spawn Claude instance: bb claude:spawn <name>"
   :requires ([babashka.nrepl-client :as nrepl])
   :task (let [name (or (first *command-line-args*) "default")
               result (nrepl/eval-expr {:port 7888 :expr (str "(claude-service/spawn! \"" name "\")")})]
           (println (first (:vals result))))}

  claude:ask
  {:doc "Ask Claude instance: bb claude:ask <name> <prompt>"
   :requires ([babashka.nrepl-client :as nrepl])
   :task (let [[name & prompt-parts] *command-line-args*
               prompt (clojure.string/join " " prompt-parts)]
           (if (and name (seq prompt))
             (let [code (str "(claude-service/ask \"" name "\" \"" (clojure.string/escape prompt {\" "\\\""}) "\")")
                   result (nrepl/eval-expr {:port 7888 :expr code})]
               (println (first (:vals result))))
             (println "Usage: bb claude:ask <name> <prompt>")))}

  claude:list
  {:doc "List all Claude instances"
   :requires ([babashka.nrepl-client :as nrepl])
   :task (let [result (nrepl/eval-expr {:port 7888 :expr "(claude-service/list-services)"})]
           (println (first (:vals result))))}

  claude:status
  {:doc "Get status of Claude instance(s): bb claude:status [name]"
   :requires ([babashka.nrepl-client :as nrepl])
   :task (let [name (first *command-line-args*)
               code (if name
                      (str "(claude-service/status \"" name "\")")
                      "(claude-service/status)")
               result (nrepl/eval-expr {:port 7888 :expr code})]
           (println (first (:vals result))))}

  claude:fork
  {:doc "Fork Claude instance: bb claude:fork <source> <new-name>"
   :requires ([babashka.nrepl-client :as nrepl])
   :task (let [[source new-name] *command-line-args*]
           (if (and source new-name)
             (let [result (nrepl/eval-expr {:port 7888 :expr (str "(claude-service/fork! \"" source "\" \"" new-name "\")")})]
               (println (first (:vals result))))
             (println "Usage: bb claude:fork <source> <new-name>")))}

  claude:kill
  {:doc "Kill Claude instance: bb claude:kill <name>"
   :requires ([babashka.nrepl-client :as nrepl])
   :task (let [name (or (first *command-line-args*) "default")
               result (nrepl/eval-expr {:port 7888 :expr (str "(claude-service/kill! \"" name "\")")})]
           (println (first (:vals result))))}

  claude:kill-all
  {:doc "Kill all Claude instances"
   :requires ([babashka.nrepl-client :as nrepl])
   :task (let [result (nrepl/eval-expr {:port 7888 :expr "(claude-service/kill-all!)"})]
           (println (first (:vals result))))}}}
